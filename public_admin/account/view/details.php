<?php/* Add this on all pages on top. */set_include_path($_SERVER['DOCUMENT_ROOT'].'/'.PATH_SEPARATOR.$_SERVER['DOCUMENT_ROOT'].'/library/classes/');/*** Standard includes */require_once 'config/database.php';require_once 'config/smarty.php';/*** Check for login */require_once 'includes/auth.php';/* objects. */require_once 'class/account.php';require_once 'class/File.php';$accountObject 			= new class_account();$fileObject 					= new File(array('gif', 'png', 'jpg', 'jpeg', 'gif'));if (isset($_GET['code']) && trim($_GET['code']) != '') {		$code = trim($_GET['code']);		$accountData = $accountObject->getByCode($code);		if($accountData) {		$smarty->assign('accountData', $accountData);	} else {		header('Location: /account/view/');		exit;			}}/* Check posted data. */if(count($_POST) > 0) {	$errorArray		= array();	$data 				= array();	$formValid		= true;	$success			= NULL;	$areaByName	= NULL;		if(isset($_POST['areapost_code']) && trim($_POST['areapost_code']) == '') {		$errorArray['areapost_code'] = 'required';		$formValid = false;			}		if(isset($_POST['account_name']) && trim($_POST['account_name']) == '') {		$errorArray['account_name'] = 'required';		$formValid = false;			}		if(isset($_POST['account_surname']) && trim($_POST['account_surname']) == '') {		$errorArray['account_surname'] = 'required';		$formValid = false;			}		if(isset($_POST['account_email']) && trim($_POST['account_email']) != '') {		if($accountObject->validateEmail(trim($_POST['account_email'])) == '') {			$errorArray['account_email'] = 'Needs to be a valid email address';			$formValid = false;			} else {						$email = isset($accountData) ? $accountData['account_code'] : null;			$emailData = $accountObject->getByEmail(trim($_POST['account_email']), $email);						if($emailData) {				$errorArray['account_email'] = 'Email already exists';				$formValid = false;							}		}	}		if(isset($_POST['account_cellphone']) && trim($_POST['account_cellphone']) != '') {		if($accountObject->validateCell(trim($_POST['account_cellphone'])) == '') {			$errorArray['account_cellphone'] = 'Needs to be a valid cellphone';			$formValid = false;			} else {						$cell = isset($accountData) ? $accountData['account_code'] : null;						$cellData = $accountObject->getByCell(trim($_POST['account_cellphone']), $cell);						if($cellData) {				$errorArray['account_cellphone'] = 'Cell phone number already exists';				$formValid = false;							}		}	}		if(isset($_POST['account_telephone']) && trim($_POST['account_telephone']) != '') {		if($accountObject->validateCell(trim($_POST['account_telephone'])) == '') {			$errorArray['account_telephone'] = 'Needs to be a valid telephone number';			$formValid = false;			}	}			if(isset($_FILES['profileimage'])) {		/* Check validity of the CV. */		if((int)$_FILES['profileimage']['size'] != 0 && trim($_FILES['profileimage']['name']) != '') {			/* Check if its the right file. */			$ext = $fileObject->file_extention($_FILES['profileimage']['name']); 			if($ext != '') {								$checkExt = $fileObject->getValidateExtention('profileimage', $ext);							if(!$checkExt) {					$errorArray['profileimage'] = 'Invalid file type something funny with the file format, try another one';					$formValid = false;										}			} else {				$errorArray['profileimage'] = 'Invalid file type';				$formValid = false;												}		} else {						switch((int)$_FILES['profileimage']['error']) {				case 1 : $errorArray['profileimage'] = 'The uploaded file exceeds the maximum upload file size, should be less than 1M'; $formValid = false; break;				case 2 : $errorArray['profileimage'] = 'File size exceeds the maximum file size'; $formValid = false; break;				case 3 : $errorArray['profileimage'] = 'File was only partically uploaded, please try again'; $formValid = false; break;				//case 4 : $errorArray['profileimage'] = 'No file was uploaded'; $formValid = false; break;				case 6 : $errorArray['profileimage'] = 'Missing a temporary folder'; $formValid = false; break;				case 7 : $errorArray['profileimage'] = 'Faild to write file to disk'; $formValid = false; break;			}		}	}		if(count($errorArray) == 0 && $formValid == true) {				$data 	= array();						$data['areapost_code']				= trim($_POST['areapost_code']);				$data['account_name']				= trim($_POST['account_name']);				$data['account_email']				= trim($_POST['account_email']);				$data['account_cellphone']			= trim($_POST['account_cellphone']);				$data['account_telephone']			= trim($_POST['account_telephone']);				if(!isset($accountData)) {						$success = $accountObject->insert($data);						} else {			$where		= $accountObject->getAdapter()->quoteInto('account_code = ?', $accountData['account_code']);			$accountObject->update($data, $where);					$success 	= $accountData['account_code'];					}				/* Upload image if its added. */		if((int)$_FILES['profileimage']['size'] != 0 && trim($_FILES['profileimage']['name']) != '') {						$image = array();			$image['account_image_name']	= $accountObject->createFile();			$image['account_image_path']		= '';			$image['account_image_ext']		= '';						$ext 						= strtolower($fileObject->file_extention($_FILES['profileimage']['name']));								$filename				= $image['account_image_name'].'.'.$ext;						$directory				= realpath(__DIR__.'/../../../public_html/').'/media/account/'.$success.'/';			$file						= $directory.'/'.$filename;							if(!is_dir($directory)) mkdir($directory, 0777, true);			/* Create files for this product type. */			foreach($fileObject->image as $item) {								$newfilename = str_replace($filename, $item['code'].$filename, $file);								/* Create new file and rename it. */				$uploadObject	= PhpThumbFactory::create($_FILES['profileimage']['tmp_name']);				$uploadObject->resize($item['width'], $item['height']);				$uploadObject->save($newfilename);						}			$image['account_image_path']	= '/media/account/'.$success.'/';			$image['account_image_ext']		= '.'.$ext;			$image['account_code'] 				= $success;						$where = $accountObject->getAdapter()->quoteInto('account_code = ?', $success);			$accountObject->update($image, $where);							}				if(count($errorArray) == 0) {			header('Location: /account/view/');				exit;				}					}		/* if we are here there are errors. */	$smarty->assign('errorArray', $errorArray);	}$smarty->display('account/view/details.tpl');?>